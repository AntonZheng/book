# Using Remote Server {#remote-server}

Sooner-or-later you are in a situation where you have to work on a
**distant networked computer**.  There may be many reasons, either
your laptop is simply to weak for certain tasks, or certain data is
not allowed to be taken out from where it is, or you are expected to use the
same computer as your teammates.  The server may be a standalone box
located on a rack in your employer's server room, or it may be a
virtual machine in a cloud, as in Amazon EC2.  You may also want to
set up your own server.


## Server Setup

There are many ways one can set up a distant machine.  It may be
windows or linux (or any of the other unixes).  It may or may not have
graphical user interface (GUI) installed or otherwise accessible (many
unix programs can display nice windows on your laptop while still
running on the server).  It may or may not have RStudio made
available over web browser.  Here we discuss the most barebone setup
with no access to GUI and no web access to RStudio.

This is a fairly common setup, in particular when dealing with
sensitive data, or in organizations where computer skills and
sysadmin's time is limited.


## Connecting to the Remote Server

Your first task is to connect to the remote server.  Here it means
that you will enter commands on your laptop, but those command are
actually run on the server.

The most common way to connect to remote server is via _ssh_.  ssh
stands for "secure shell" and means that both login and all
communication with the server is encrypted.  You connect to the server
as 
```bash
ssh myserver.somewhere.com
```
The remote server asks for your password and opens remote shell
connection.  It a similar bash-shell as you are using
on your computer but most likely you see a different prompt, one that
contains the server's name.  You may also see some login
messages.   Now all the commands you are issuing are
running on the remote machine.  So `pwd` shows your working
directory on the server, which in general is not the same as on the
local machine, and `ls` shows the files on the server, not on your
laptop.  Now you can use `mkdir` to create the project folder on the
server. 

By default, ssh attempts to login with your local username.  If your
username on the server differs from that on your laptop, you want to add it to the ssh command:
```bash
ssh username@myserver.somewhere.com
```

Finally, you have to get out of here.  The polite way to do it is with
command
```bash
exit
```
that ensures that the connection will be safely closed.  Usually you
can also just close the terminal.


## Copying Files

Before you can start running R scripts on the server, you have to get
these copied over.  There are several possibilities.

### scp

The most straightforward approach is `scp`, secure copy.  It works in many
ways in the same way as `cp` for the local files, just `scp` can copy
files between your machine and a remote computer.  Under the hood it uses ssh
connection, just like `ssh` command itself.  It syntax is rather
similar to that of `cp`:
```bash
scp user1@host1:file1 user2@host2:file2
```
This copies "file1" from the server "host1" under username "user1" to
the other server.  It asks for passwords as needed.  the "host" part
of the file must be understood as the full hostname including dots,
such as "hyak.washington.edu".  "file" is the full path to file,
relative to home directory, such as "info201/cool\_script.R".
When accessing local files, you may omit the "user@host:" part.  So,
for instance, in order to copy your "cool\_script.R" from folder
"info201" on your laptop's Desktop to the folder "scripts" in
your home folder on the server, you may issue 
```bash 
scp Desktop/info201/cool_script.R myusername@server.ischool.edu:scripts/
``` 
(here we assume the working directory of your laptop is the one above
`Desktop`.) 
Note that exactly as `cp`, you may omit the destination file name
if the destination is a directory: it simply copies the file into that
directory while preserving it's name.

After running your script, you may want to copy your results back to
your laptop.  For instance, if you need to get the file
"figure.pdf" out of the server, you can do
```bash
scp myusername@server.ischool.edu:scripts/figure.pdf Desktop/info201/
```
As above, this copies a file from the given directory, and drops it
into the "info201" folder on your Desktop.


### rsync

`rsync` is a more advanced approach to `scp`.  It works in many ways
exactly like `scp`, just it is smart enough to understand which files
are updated, and only copy the updated parts of the files.  It is the
recommended way to go if dealing with small updates in large files.
It's syntax is rather similar to that of `scp`.  To copy "file" to the
remote server as "file2", we do
```
rsync file user2@host2:file2
```
and in order to copy a "file1" from server as local "file":
```
rsync file user1@host1:file1 file
```
I also recommend to
explore some of it's many options, for instance `-v` (verbose) reports
what it's doing.
The example above with your code and figure might now look like that:
```bash
rsync -v Desktop/info201/cool_script.R myusername@server.ischool.edu:scripts/
# now run the script on the remote machine
rsync -v myusername@server.ischool.edu:scripts/figure.pdf Desktop/info201/
```

Maybe the easiest way to copy your files is to copy (or update) the whole
directories.  For instance, instead of the code above, you can do
```bash
# copy all files to server:
rsync -v Desktop/info201/* myusername@server.ischool.edu:scripts/
# now run the script on the remote machine
# ... and copy the results back:
rsync -v myusername@server.ischool.edu:scripts/* Desktop/info201/
```
Here `*` means _all files in this directory_.  Hence, instead of
copying the files individually between the computers, we just copy
all
of them.  Even better, we actually do not copy but just update.  Huge
files that do not change do not take any bandwidth.


### Graphical Frontends

Instead on relying on command line tools, one can also use graphical
front-ends.  For instance, "WinSCP" is a nice Norton Commander-Style
frontend for copying files between the local and a remote machine over scp
for Windows.  It provides a split window representing files on the
local and the remote end, and one can move, copy-and-paste and interact
with mouse on these panes.  On Mac you may take a look at
"Cyberduck". 


### Remote Editing

Besides copying your files, many text editors also offer "remote
editing" option.  From the user perspective this looks as if directly
working on the remote server's hard disk.  Under the hood, the files
are copied back and forth with scp, rsync or one of their friends.
Emacs and vi do it out-of-the box, VSCode, Atom and sublime require a
plugin.  AFAIK it is not possible with RStudio.

It is also possible to mount (attach) the harddisk of the remote
server to your laptop as if it were a local disk.  Look yourself for
more information if you are interested.



## R and Rscript

When you code has been transferred to the server, your next task is to
run it.  But before you can do it, you may want to install the
packages you need.  For instance, you may want to install the whole
"tidyverse" bundle.  This must be done from R console using
`install.packages()`.  The first time you do it, R complains about
non-writeable syste-wide library and proposes to install and create
your personal libary.  You should answer "yes" to these prompts.  As
linux systems typically compile the packages during installations, the
process is slow and you see many messages (including warnings) in the
process.  But it works, given that the necessary libraries are there.

Now you can finally run your R code.  I strongly recommend to do it
from the directory where you intend to run the project before starting
R (`cd scripts`).  There are two options: either start R
interactively, or run it as a script.

You start R interactively by the command 
```bash
R
```
It opens an R session, not unlike what you see inside of RStudio, just
here you have no RStudio to handrail you through the session.  Now all loading,
saving, inspecting files, etc must be done through R commands.  For
instance, in order to run the script, you have to _source_ it like
```R
source("cool_script.R")
```
This runs the script, possibly ending with an error message.  You have
to correct the error either on your laptop and copy the file over to
the server again, or directly on the server, and
re-run it again.  Note that you don't have to exit from the R session when
copying the script file over to the server.  Edit it, copy it over
from your laptop (using `scp` or
other tools), and just re-source the file from
withing the R session.

Opening a separate R session may be useful for installing packages.
For running your scripts, i recommend you to run it entirely from
command line, either as
```bash
R CMD BATCH cool_script.R
```
or
```bash
Rscript cool_script.R
```
The first version produces a little more meaningful error messages,
the other one handles the environment in a little more consistent and
efficient manner.


### Graphics Output with No GUI

If the server does not have any graphics capabilities, you have to
save your figures as files.  For instance, to save the image in a pdf
file, you may use the following code in your R program:
```R
pdf(file="figure1.pdf", width=12, height=8)
    # width and height in inches
# do your plotting here
plot(1:10, rnorm(10))
# done plotting
dev.off()
    # saves the image to disk and closes the file.
```
afterwards you will have to copy the image file to your laptop for
inspection or addition in your final project report.



## Life on Server

The servers operate in many ways in a similar fashion as the command line
on your own computer.  However, there is a number of differences.

### Be Social!

While you laptop is yours, and you are free to exploit all it's
resources for your own good, this is not true for the server.  The server is a
multiuser system, potentially doing good work for many people at the
same time.  So
the first rule is: **Don't take more resources than what you need!**

This means don't let the system run, grab memory, or occupy disk space
just for fun or laziness.  Try to keep your R workspace clean and
close R as soon as it has finished.  Don't copy the dataset without a
good reason, and keep your copies in a compressed form.  R can open
gzip and bzip2 files on the fly, so usually you don't even need to
decompress these.  Avoid costly recalculations of something you
already calculated.  All this is specially true the last days before the deadline
when many people try to run their stuff at the same time.

Servers are typically well configured to tame misbehaving programs.
You may sometimes see your script stopping with a message "killed".
This most likely means that the script grabbed too much memory, and the system
just killed it.  Deal with it.


### Useful Things to Do

There are several useful commands you can experiment with on the
server.
```bash
htop
```
(press `q` to quit) tells you which programs run on the server, how much memory and cpu do
these take, and who are their owners (the corresponding users).  It
also permits you to kill your misbehaving processes (press `k` and
select `SIGKILL`).  Read more with `man htop`.

```bash
w
```
(**w**ho) prints the current logged-in users of the server.

```bash
df -h
```
(**d**isplay **f**ree in **h**uman-readable units) shows the free and
occupied disk space.  You are mainly influenced by what is going on in the file system
`/home`.

### Permissions and ownership

Unix systems are very strict about ownership and permissions.  You are
a normal user with limited privileges.  In particular, you cannot
modify or delete files that you don't own.  In a similar fashion, you
cannot kill processes you did not start.  Feel free to attempt.  It
won't work.

In case you need to do something with elevated privileges (as
"superuser"), you contact your system administrator.  In practice,
their responsiveness and willingness to accommodate your requests will
vary. 

### More than One Connection

It perfectly possible to log onto the server multiple times at the
same time.  You may simply open several terminals and log onto the
server from each of these.  You can use one to look how you script is
doing with `htop`, the other to run the script, the third to inspect
output...  If you find such approach useful, I recommend you to
familiarize yourself with gnu screen (command `screen` that includes
many related goodies.)


## Advanced Usage

### ssh keys, .ssh/config

Without further configuration, every time you open a ssh connection,
you have to insert your password again.  Instead of re-entering it
over and over again (this may not even be secure), you can configure
your ssh keys and copy it to the server.  Next time, you will be
automatically authenticated with the key and no password is
necessary.  Note: this is the same ssh key that is used by GitHub if
you use ssh connection to GitHub.

(Should find a nice link instead of explaining it here) 
- ssh-keygen
- passphrase
- ssh-copy-id
- .ssh/config


### Running RScript in ssh Session

Passwordless ssh connection gives you new wonderful possibilities.
First, you don't even have to log into the server explicitly.  You can
run a one-command ssh session on your server directly from your
laptop.  Namely, ssh accepts commands to be run on the remote
machine.  If invoked by something like
```bash
ssh myusername@server.ischool.edu Rscript script.R
```
It does not open a remote shell but runs `Rscript script.R` instead.
Your command sequence for the whole process will accordingly look something like:
```bash
rsync -v Desktop/info201/* myusername@server.ischool.edu:scripts/
ssh myusername@server.ischool.edu Rscripts scripts/cool_script.R
rsync -v myusername@server.ischool.edu:scripts/* Desktop/info201/
```
All these command are issued on your laptop.  You can also save these
to a text file and run all three together as a single **shell
script**!
- a nice link to shell scripts

Further, we can also explain R on our laptop how to start R on the
remote server over ssh.  In this way you can turn your laptop and server
together into a high-performance-computing cluster!  This allows you
to copy the script and run it on the server directly from within your
R program that runs
on your laptop.  Cluster computing is out of scope of this book, but if you
are interested, look up the **makePSOCKcluster()** function in **parallel**
package. 
