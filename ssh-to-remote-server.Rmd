# Using Remote Server {#remote-server}

Sooner-or-later you are in a situation where you have to work on a
**distant networked computer**.  There may be many reasons, either
your laptop is simply to weak for certain tasks, or certain data is
not allowed to be taken out from there, or you are expected to use the
same computer as your teammates.  The server may be a standalone box
located on a rack in your employers server room, or it may be a
virtual maching in cloud, such as Amazon EC2.  You may also want to
set up your own server.


## Server Setup

There are many ways one can set up a distant machine.  It may be
windows or linux (or any of the other unixes).  It may or may not have
graphical user interface (GUI) installed or otherwise accessible (many
unix programs can display nice windows on your laptop while still
running on the server).  It may or may not have RStudio made
available over web browser.  Here we discuss the most barebone setup
with no access to GUI and no web access to RStudio.

This is a fairly common setup, in particular when dealing with
sensitive data, or in organizations where computer skills and
sysadmin's time is limited.


## Connecting to the Remote Server

Your first task is to connect to the remote server.  Here it means
that you will enter commands on your laptop, but those command are
actually run on the server.

The most common way to connect to remote server is via _ssh_.  ssh
stands for "secure shell" and means that both login and all
communication with the server is encrypted.  You connect to the server
as 
```bash
ssh myserver.somewhere.com
```
The remote server asks for your password and opens remote shell
connection.  It is most likely a similar bash-shell as you are using
on your computer but most likely you see a different prompt, one that
contains the server's name.  You may also see some login
messages.   Now all the commands you are issuing are
running on the remote machine.  So `pwd` shows you your working
directory on the server, which in general is not the same as on the
local machine, and `ls` shows the files on the server, not on your
laptop.  Now you can use `mkdir` to create the project folder on the
server. 

By default, ssh attempts to login with you local username.  If your
username on the server differs, you want to add it to the ssh command:
```bash
ssh username@myserver.somewhere.com
```

## copying files

Before you can start running R scripts on the server, you have to get
these copied over.  There are several possibilities.

### scp

The most universal approach is `scp`, secure copy.  It works in many
ways in the same way as `cp` for the local files, just `scp` can copy
files between your machine and a remote computer.  Under the hood it uses ssh
connection, just like `ssh` command itself.  It syntax is rather
similar to that of `cp`:
```bash
scp user1@host1:file1 user2@host2:file2
```
This copies "file1" from the server "host1" under username "user1" to
the other server.  It asks for passwords as needed.  the "host" part
of the file must be understood as the full hostname including dots,
such as "hyak.washington.edu".  "file" is the full path to file,
relative to home folder, such as "info201/cool_script.R".  When
accessing local files, you may omit the "user@host:" part.  So, for
instance, in order to copy your "cool\_script.R" from folder "info201"
on the Desktop of your laptop to the folder "scripts" on your home
folder on the server, you may issue
```bash
scp Desktop/info201/cool_script.R myusername@server.ischool.edu:scripts/
```
Note that exactly as `cp`, you may omit the destination file name if
the destination is a directory: it simply copies the file into that
directory while preserving it's name.

After running your script, you may want to copy your result--the file
"figure.pdf" back to your laptop.  This can be done with
```bash
scp myusername@server.ischool.edu:scripts/figure.pdf Desktop/info201/
```
As above, this copies a file from the given directory, and drops it
into the "info201" folder on your Desktop.


### rsync

`rsync` is a more modern approach to `scp`.  It works in many way
exactly like `scp`, just is is smart enough to understand which files
are updated, and only copy the updated parts of the files.  It is the
recommended way to go if dealing with small updates in large files.
It's syntax is rather similar to that of `scp`.  To copy a "file" to the
remote server as "file2", we do
```
rsync file user2@host2:file2
```
and in order to copy a "file1" from server as local "file":
```
rsync file user1@host1:file1 file
```
(rsync cannot copy between two remote computers).  I also recommend to
explore some of the many options, for instance `-v` (verbose) reports
what it's doing.
The example above with your code and figure might now look like that:
```bash
rsync -v Desktop/info201/cool_script.R myusername@server.ischool.edu:scripts/
# now run the script on the remote machine
rsync -v myusername@server.ischool.edu:scripts/figure.pdf Desktop/info201/
```

Maybe the easiest way to copy your files is to copy the whole
directories.  For instance, instead of the code above, you can do
```bash
rsync -v Desktop/info201/* myusername@server.ischool.edu:scripts/
# now run the script on the remote machine
rsync -v myusername@server.ischool.edu:scripts/* Desktop/info201/
```
Here `*` means _all files in this directory_.  Hence, now, instead of
copying the files individually between the computers, we just copy all
of them.  Even better, we actually do not copy but just update.  Huge
files that do not change do not take any bandwidth.


### Graphical Frontends

Instead on relying on command line tools, one can also use graphical
front-ends.  For instance, "WinSCP" is a nice Norton-Commander-Style
frontend for copying files between local and remote machine over scp
for Windows.  It provides a split window representing files on the
local and remote end, and one can move, copy-and-paste and interact
with mouse in these areas.  On Mac you may take a look at
"Cyberduck". 


### remote editing

Besides copying your files, many text editors also offer "remote
editing" option.  From the user perspective this looks as if directly
working on the remote server's hard disk.  Under the hood, the files
are copied back and forth with scp, rsync or one of their friends.
Emacs and vi do it out-of-the box, VSCode, Atom and sublime requirea
plugin.  AFAIK it is not possible with RStudio.

It is also possible to mount (attach) the harddisk of the remote
server to your laptop as if it were a local disk.  Again, scp and
friends will do the hard work under the hood.



## Rscript

When you code has been transferred to the server, your next task is to
run it.  There are two options: either start R interactively, or run
it as a script.

You start R interactively by the command 
```bash
R
```
It opens an R session, not unlike what you see inside of RStudio, just
here is no RStudio to handrail you through the sessions.  All loading,
saving, inspecting files, etc must be done through R commands.  For
instance, in order to run the script, you have to _source_ it like
```R
source("cool_script.R")
```
This runs the script, possibly ending with an error message.  You have
to correct the error, copy the file over to the server again, and
re-run it.  Note that you don't have to exit from the R session when
copying the script file over to the server.  Edit it, copy it (using `scp` or
other tools) over from your laptop, and just re-source the file from
withing the R session.

Alternatively, instead of opening the interactive R session, you can
run it entirely from the command line.
```bash
R cool_script.R
```
or
```bash
Rscript cool_script.R
```
are two different ways to run your script.


### graphics output

If the server does not have any graphics capabilities, you have to
save your figures as files.  For instance, to save the image in a pdf
file, you may use the following code in your R program:
```R
pdf(file="figure1.pdf", width=12, height=8)
    # width and height in inches
# do your plotting here
dev.off()
    # saves the image to disk and closes the file.
```
afterwards you will have to copy the image file to your laptop for
further inspection or addition in your project report.



## Life on Server

The servers operate in many ways in a similar fashion as command line
on your own computer.  However, there is a number of differences.

### Be Social!

While you laptop is yours, and you are free to grab all it's resources
to yourself, this is not true for the server.  The server is a
multiuser system, potentially used concurrently by many people.  So
the first rule is:
> Don't take more resources than what you need!

This means don't let the system run, grab memory, or occupy disk space
just for fun or laziness.  Try to keep your R workspace clean and
close R as soon as it has finished.  Don't copy the dataset without a
good reason, and keep your copies in a compressed form.  R can open
gzip and bzip2 files on the fly, so usually you don't even need to
decompress these.  Avoid costly recalculations of something you
already calculated.  All this is specially true before the deadline
when many people try to run their stuff on server.


### Useful Things to Do

There are several useful commands you can experiment with on the
server.
```bash
htop
```
tells you which programs run on the server, how much memory and cpu do
these take, and who are their owners (the corresponding users).  It
also permits you to kill your misbehaving processes (press `k` and
select `SIGKILL`).

```bash
w
```
(who) prints the current logged-in users of the server.

```bash
df -h
```
(**d**isplay **f**ree in **h**uman-readable units) shows the free and
occupied disk space.  You are mainly influenced by the file system
`/home`.

### Permissions and ownership

Unix systems are very strict about ownership and permissions.  You are
a normal user with limited privileges.  In particular, you cannot
modify or delete files that you don't own.  In a similar fashion, you
cannot kill processes you did not start.  Feel free and attempt to
kill these, and delete files of others.  But you can't.



## Advanced Usage

### ssh keys, .ssh/config

Withough further configuration, every time you open a ssh connection,
you have to insert your password again.  Instead of re-entering it
over and over again (this may not even be secure), you can configure
your ssh keys and copy it to the server.  Next time, you will be
automatically authenticated with the key and no password is
necessary.  Note: this is the same ssh key that is used by GitHub if
you use ssh connection to GitHub.

(Should find a nice link instead of explaining it here) 
- ssh-keygen
- passphrase
- ssh-copy-id


### running RScript in ssh session

Passwordless ssh connection gives you new wonderful possibilities.
First, you don't even have to log into the server explicitly.  You can
run a one-command ssh session on your server directly from your
laptop.  Namely, ssh accepts commands to be run on the remote
machine.  If invoked by something like
```bash
ssh myusername@server.ischool.edu Rscript script.R
```
It does not open a remote shell but runs `Rscript script.R` instead.
You command sequence for the whole process will accordingly look something like:
```bash
rsync -v Desktop/info201/* myusername@server.ischool.edu:scripts/
ssh myusername@server.ischool.edu Rscripts scripts/cool_script.R
rsync -v myusername@server.ischool.edu:scripts/* Desktop/info201/
```
All these command are issued on your laptop.  You can also save these
to a text file and run all three together as a single **shell
script**!

Further, we can also explain R on our laptop how to start R on the
remote server over ssh.  In this way you can turn your laptop and server
together into a high-performance-computing cluster!  This allows you
to copy the script and run it on the server directly from within your
R program that runs
on your laptop.  Cluster computing is out of scope of this book, but if you
are interested, look up the **snow** (simple network of workstations)
package. 
